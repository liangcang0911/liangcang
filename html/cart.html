<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>良仓.生活美学平台</title>
		<link rel="icon" href="../images/favicon.ico"/>
		<link rel="stylesheet" href="../css/index.css" />
		<link rel="stylesheet" href="../css/top.css" />
	</head>
	<body>
		<div class="header">
			<div class="items-logo">
				<div>
					<a class="logo" href="index.html"></a>
					<ul>
						<li><a href="sign-in.html" class="first">登录</a>  &nbsp;<a href="sign-up.html" class="first">注册</a></li>
						<li class="line">|</li>
						<li id="shopping-cart">
							<a href="cart.html">购物车</a>
							<div class="cart">
								<div class="goods">
									你的购物车暂时没有商品...
								</div>
								<a href="#">快去请购良仓商品吧！</a>
							</div>
						</li>
						<li class="line">|</li>
						<li id="information1">
							<a href="information.html">消息</a>
							<ol>
								<li>
									<a href="movement.html">
										动态<span>0</span>
									</a>
								</li>
								<li>
									<a href="information.html">
										评论<span>0</span>
									</a>
								</li>
								<li>
									<a href="personal-letter.html">
										私信<span>0</span>
									</a>
								</li>
								<li>
									<a href="fans.html">
										粉丝<span>0</span>
									</a>
								</li>
								<li>
									<a href="like.html">
										喜欢<span>0</span>
									</a>
								</li>
								<li>
									<a href="inform.html">
										通知<span>0</span>
									</a>
								</li>
							</ol>
						</li>
						<li class="line">|</li>
						<li><a href="add.html">添加良品</a></li>
					</ul>
				</div>				
			</div>
			<div class="items-nav" id="items-nav">
				<div>
					<ul>
						<li class="first"><a href="#">首页</a></li>
						<li id="shop">
							<a href="#">商店</a>
							<div class="shop">
								<div>
									<div class="shop-list">
										<ul>
											<li>
												<a href="#">
													<img src="../images/23687.png"/>
													<span>家居</span>											
												</a>
												<div class="shop-list-second">
													
												</div>
											</li>
											<li>
												<a href="#">
													<img src="../images/23685.png"/>
													<span>家具</span>											
												</a>
												<div class="shop-list-second">
													
												</div>
											</li>
											<li>
												<a href="#">
													<img src="../images/23686.png"/>
													<span>文具</span>											
												</a>
												<div class="shop-list-second">
													
												</div>
											</li>
											<li>
												<a href="#">
													<img src="../images/23683.png"/>
													<span>数码</span>											
												</a>
												<div class="shop-list-second">
													
												</div>
											</li>
											<li>
												<a href="#">
													<img src="../images/23682.png"/>
													<span>娱乐</span>											
												</a>
												<div class="shop-list-second">
													
												</div>
											</li>
											<li>
												<a href="#">
													<img src="../images/23684.png"/>
													<span>厨卫</span>											
												</a>
												<div class="shop-list-second">
													
												</div>
											</li>
											<li>
												<a href="#">
													<img src="../images/23680.png"/>
													<span>美食</span>											
												</a>
												<div class="shop-list-second">
													
												</div>
											</li>
											<li>
												<a href="#">
													<img src="../images/23679.png"/>
													<span>男装</span>											
												</a>
												<div class="shop-list-second">
													
												</div>
											</li>
											<li>
												<a href="#">
													<img src="../images/23678.png"/>
													<span>女装</span>											
												</a>
												<div class="shop-list-second">
													
												</div>
											</li>
											<li>
												<a href="#">
													<img src="../images/23677.png"/>
													<span>童装</span>											
												</a>
												<div class="shop-list-second">
													
												</div>
											</li>									
										</ul>
										<a href="#" class="pic">
											<img src="../images/315574.jpg"/>
											<span>新视线： 2015年7月刊</span>
										</a>
									</div>
									<div class="details">
										<a href="">查看所有品牌 &gt;</a>
										<a href="">最新到货 &gt;</a>
									</div>
								</div>
							</div>
						</li>
						<li id="magazin">
							<a href="#">杂志</a>
							<div class="magazin share">
								<ul>
									<li><a href="#">趣物</a></li>
									<li><a href="#">数码</a></li>
									<li><a href="#">汽车</a></li>
									<li><a href="#">文化</a></li>
									<li><a href="#">时尚</a></li>
									<li><a href="#">美食</a></li>
									<li><a href="#">建筑</a></li>
									<li><a href="#">空间</a></li>
									<li><a href="#">圈子</a></li>
									<li><a href="#">清单</a></li>
									<li><a href="#">活动</a></li>
									<li><a href="#">视频</a></li>
								</ul>
							</div>
						</li>
						<li id="share">
							<a href="#">分享</a>
							<div class="magazin share">
								<ul>
									<li><a href="#">男士</a></li>
									<li><a href="#">家居</a></li>
									<li><a href="#">数码</a></li>
									<li><a href="#">文具</a></li>
									<li><a href="#">玩具</a></li>
									<li><a href="#">美容</a></li>
									<li><a href="#">孩子</a></li>
									<li><a href="#">宠物</a></li>
									<li><a href="#">饮食</a></li>
									<li><a href="#">运动</a></li>
									<li><a href="#">文化</a></li>
									<li><a href="#">女士</a></li>
								</ul>
							</div>
						</li>
						<li><a href="#">达人</a></li>
					</ul>
					<div class="search">
						<div>
							<input id="search-ipt" type="text" placeholder="search..."/>
						</div>
						<a href="#" id="search-btn"></a>
					</div>			
				</div>
			</div>
		</div>
		<div id="shoptype">
			<div id="shopitem">
				<span id="span3">购物车</span>
				<span id="span4">付款</span>
			</div>
		</div>
		<main>
		    <table>
		      <tr>
		        <td>图片</td>
		        <td>商品ID</td>
		        <td>名称</td>
		        <td>数量</td>
		        <td>单价</td>
		        <td>总价</td>
		        <td>操作</td>
		      </tr>
		    </table>
		    <div id="needmoney">良品总价：<span id="sum">0</span></div>
    	    <div class="clear-cart"><input type="button" id="clear-cart" value="清空购物车"></div>
    	    <div class="clear-cart"><a href="pay.html">立即结算</a></div>
		</main>
		<div class="footer">
			<div class="icon">
				<a href="#">
					<span class="hand"></span>
					<span class="shop-icon"></span>
				</a>				
			</div>
			<div class="slogen">
				<dl>
					<dt class="dt1"></dt>
					<dd>
						<p class="chinese">全球精品</p>
						<p class="english">Global Selection</p>
					</dd>
				</dl>
				<dl>
					<dt class="dt2"></dt>
					<dd>
						<p class="chinese">正品保证</p>
						<p class="english">Autherticity Guaranteed</p>
					</dd>
				</dl>
				<dl>
					<dt class="dt3"></dt>
					<dd>
						<p class="chinese">全场包邮</p>
						<p class="english">Free Delivery</p>
					</dd>
				</dl>
				<dl>
					<dt class="dt4"></dt>
					<dd>
						<p class="chinese">400-897-6336</p>
						<p class="english">工作日 09:00-18:00</p>
					</dd>
				</dl>
			</div>	
		</div>
		<div class="copy">
			<div class="copy-top">
				<a class="phone" href="#">
					<i></i>
					<div class="text">
						<p>iPone Android</p>
						<p>客户端下载</p>
					</div>
					<div class="code">
						<dl class="dl1">
							<dt></dt>
							<dd>下载iPone版</dd>
						</dl>
						<dl class="dl2">
							<dt></dt>
							<dd>下载Android版</dd>
						</dl>
					</div>
				</a>
				<ul>
					<li class="wx">
						<i></i>
						<a href="#"></a>
					</li>
					<li class="wb"><a href="#"></a></li>
					<li class="db"><a href="#"></a></li>
				</ul>
			</div>
			<div class="copy-down">
				<ul>
					<li class="first"><a href="#">关于良仓</a></li>
					<li><a href="#">服务协议</a></li>
					<li><a href="#">隐私保护政策</a></li>
					<li><a href="#">使用指南</a></li>
					<li><a href="#">联系我们</a></li>
					<li><a href="#">加入我们</a></li>
					<li><a href="#">友情链接</a></li>
					<li><a href="#">私信良仓</a></li>
				</ul>
				<p class="copy-code">
					<span>&copy;</span>
					<span>2013-2015 北京良仓文化传播有限公司版权所有 京</span>
					<span>京ICP备13010677号-1</span>
					<span>京公网安备11010502025627</span>
				</p>
				<p class="company">公司名称：北京良仓文化传播有限公司  电话：010-58263516</p>
				<p class="address">公司地址：北京朝阳区百子湾路32号6号楼1层60号.</p>
				<p class="licence">社会信用统一代码：91110105059231575L  食品许可证：JY11105160159557  </p>
				<p class="library-card"> 图书证名称：中华人民共和国出版物经营许可证  图书证编号：新出发京零 字第 朝 150051 号 </p>
			</div>
		</div>
	</body>
	<!--<script src="../js/tcart.js" charset="utf-8"></script>-->
	<script src="../js/animate.js" type="text/javascript" charset="utf-8"></script>
	<script src="../js/myajax.js" type="text/javascript" charset="utf-8"></script>
	<!--<script src="../js/index.js" type="text/javascript" charset="utf-8"></script>-->
	<script>
    var oTable = document.querySelector('table');
    var oSum = document.querySelector('#sum');
    myajax.get('http://h6.duchengjiu.top/shop/api_cart.php', {token: localStorage.token}, function(err, responseText){
      var json = JSON.parse(responseText);
      console.log(json);
      var data = json.data;
      for (var i = 0; i < data.length; i++) {
        var obj = data[i];
        //一件商品的总价
        obj.goods_sum = obj.goods_price * obj.goods_number;
        oTable.innerHTML += `
                          <tr>
                            <td><img src="${obj.goods_thumb}" ></td>
                            <td name="goods_id">${obj.goods_id}</td>
                            <td>${obj.goods_name}</td>
                            <td><input data-id="${obj.goods_id}" type="number" name="number" min="1" max="10" value="${obj.goods_number}" /></td>
                            <td>&yen;${obj.goods_price}</td>
                            <td name="sum">${obj.goods_sum}</td>
                            <td><input data-id="${obj.goods_id}" type="button" name="delete" value="删除" id="control"></td>
                          </tr>
                          `;
      }
      getSum();
//    location.reload();
    });

    oTable.onchange = function(event) {
      event = event || window.event;
      var target = event.target || event.srcElement;
      if (target.name === 'number') {
        //如果输入的内容不是数字，我们默认改成1
        if (isNaN(parseInt(target.value))) {
          target.value = 1;
        }
        console.log(target.value, target.dataset.id);
        //得到商品的ID
        var goods_id = target.dataset.id;
        //得到商品的数量
        var number = target.value;
        //请求api修改购买的商品数量
        myajax.post('http://h6.duchengjiu.top/shop/api_cart.php?token='+localStorage.token,
        {goods_id, number},
        function(err, responseText) {
          var json = JSON.parse(responseText);
          console.log(json);
          if (json.code === 0) {
            // alert('更新购物车成功');
            //修改总价和小计
            //得到当前商品的价格
            var goods_price = parseInt(target.parentNode.nextElementSibling.innerText.substr(1));
            //修改单个商品的总价：数量 * 价格
            target.parentNode.nextElementSibling.nextElementSibling.innerText = parseInt(target.value) * goods_price;
            console.log(goods_price)
            //显示总价
            getSum();
//          location.reload();
          }
        })
      }
    }
    oTable.addEventListener('click', function(event){
      event = event || window.event;
      var target = event.target || event.srcElement;
      if (target.name === 'delete') {
        if (!confirm('确认要删除吗')) { //当你选择的是取消则不执行任何事情
          return;
        }
        //得到商品ID
        var goods_id = target.dataset.id;
        var number = 0;
        myajax.post('http://h6.duchengjiu.top/shop/api_cart.php?token='+localStorage.token,
        {goods_id, number},
        (err, responseText) => {
          var json = JSON.parse(responseText);
          console.log(json);
          if (json.code === 0) {
            // alert('更新购物车成功');
            //删除整个TR
            var tr = target.parentNode.parentNode;
            tr.parentNode.removeChild(tr);
            //显示总价
            getSum();
          }
        })
      }
    });

    var oClearCart = document.querySelector('#clear-cart');
    console.log(oClearCart)
    oClearCart.onclick = () => {
      if (!confirm('确认要清空整个购物车吗？')) {
        return;
      }
      //得到所有的商品ID
      var oGoodsIds = document.querySelectorAll('td[name=goods_id]');
      console.log(oGoodsIds)
      for (var i = 0; i < oGoodsIds.length; i++) {
        var td = oGoodsIds[i];
        var goods_id = parseInt(td.innerText);
        var number = 0;
        (function(td){
          myajax.post('http://h6.duchengjiu.top/shop/api_cart.php?token='+localStorage.token,
          {goods_id, number},
          (err, responseText) => {
            var json = JSON.parse(responseText);
            console.log(json);
            if (json.code === 0) {
              // alert('更新购物车成功');
              //删除整个TR
              var tr = td.parentNode;
              tr.parentNode.removeChild(tr);
              //显示总价
              getSum();
            }
          });
        })(td);
      }
    }

    //显示出总价
    function getSum() {
      var oSums = document.querySelectorAll('td[name=sum]');
      var sum = 0;
      for (var i = 0; i < oSums.length; i++) {
        sum += parseInt(oSums[i].innerText);
      }
      localStorage.sum = sum;
      oSum.innerText = "￥" + sum;
    }
    
  </script>
</html>
